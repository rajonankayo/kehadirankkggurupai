<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi KKG Guru PAI - Binaan Pengawas Buk Dewi Yuliani, S.Ag, M.Pd</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .scanner-container {
            max-width: 400px;
            margin: 0 auto;
        }
        #qr-reader {
            width: 100%;
        }
        .qr-display {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .admin-tab-content {
            display: block;
        }
        .admin-tab-content[style*="display: none"] {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-800 mb-2">Aplikasi Absensi KKG Guru PAI</h1>
            <p class="text-lg text-gray-600">Binaan Pengawas: Buk Dewi Yuliani, S.Ag, M.Pd</p>
            
            <!-- Setup Instructions (Hidden by default) -->
            <div id="setupInstructions" class="mt-4 p-4 bg-blue-50 rounded-lg text-left max-w-4xl mx-auto" style="display: none;">
                <h3 class="font-bold text-blue-800 mb-3">üìã Petunjuk Setup Google Apps Script:</h3>
                <div class="text-sm text-blue-700 space-y-2">
                    <p><strong>1. Buat Google Spreadsheet baru</strong> dengan 2 sheet: "DataGuru" dan "DataAbsensi"</p>
                    <p><strong>2. Di sheet "DataGuru"</strong> buat header: ID_Guru | Nama_Lengkap | Sekolah | Kecamatan | Tanggal_Dibuat</p>
                    <p><strong>3. Di sheet "DataAbsensi"</strong> buat header: ID | ID_Guru | Tanggal | Waktu | Timestamp</p>
                    <p><strong>4. Buka Extensions ‚Üí Apps Script</strong> dan paste kode berikut:</p>
                    <div class="bg-gray-800 text-green-400 p-3 rounded mt-2 text-xs overflow-x-auto">
<pre>function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  if (data.action === 'addTeacher') {
    const sheet = ss.getSheetByName('DataGuru');
    sheet.appendRow([
      data.data.id,
      data.data.name,
      data.data.school,
      data.data.district,
      new Date(data.data.createdAt)
    ]);
  } else if (data.action === 'addAttendance') {
    const sheet = ss.getSheetByName('DataAbsensi');
    sheet.appendRow([
      data.data.id,
      data.data.userId,
      data.data.date,
      data.data.time,
      new Date(data.data.timestamp)
    ]);
  }
  
  return ContentService.createTextOutput('Success');
}

function doGet(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  if (e.parameter.action === 'getTeachers') {
    const sheet = ss.getSheetByName('DataGuru');
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const rows = data.slice(1);
    
    const teachers = rows.map(row => ({
      id: row[0],
      name: row[1],
      school: row[2],
      district: row[3],
      createdAt: row[4]
    }));
    
    return ContentService
      .createTextOutput(JSON.stringify(teachers))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  if (e.parameter.action === 'getAttendance') {
    const sheet = ss.getSheetByName('DataAbsensi');
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const rows = data.slice(1);
    
    const attendance = rows.map(row => ({
      id: row[0],
      userId: row[1],
      date: row[2],
      time: row[3],
      timestamp: row[4]
    }));
    
    return ContentService
      .createTextOutput(JSON.stringify(attendance))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  return ContentService.createTextOutput('No action specified');
}</pre>
                    </div>
                    <p><strong>5. Deploy sebagai Web App</strong> dengan akses "Anyone" dan copy URL-nya</p>
                    <p><strong>6. Ganti YOUR_SCRIPT_ID</strong> di kode dengan ID script Anda</p>
                </div>
                <button onclick="document.getElementById('setupInstructions').style.display='none'" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                    Tutup Petunjuk
                </button>
            </div>
            
            <button onclick="document.getElementById('setupInstructions').style.display='block'" class="mt-2 text-blue-600 hover:text-blue-800 text-sm underline">
                üìã Lihat Petunjuk Setup Google Sheets
            </button>
        </div>

        <!-- Tab Navigation -->
        <div class="flex justify-center mb-6">
            <div class="bg-white rounded-lg p-1 shadow-md">
                <button id="userTab" class="tab-btn px-6 py-3 rounded-md font-medium transition-all duration-200 bg-indigo-600 text-white">
                    üë§ User
                </button>
                <button id="adminTab" class="tab-btn px-6 py-3 rounded-md font-medium transition-all duration-200 text-gray-600 hover:text-indigo-600">
                    üîß Admin
                </button>
            </div>
        </div>

        <!-- User Tab Content -->
        <div id="userContent" class="tab-content active">
            <!-- Login Form -->
            <div id="loginForm" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Login User</h2>
                <form id="userLoginForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">ID Guru</label>
                        <input type="text" id="userId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Masukkan ID Guru" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-200 font-medium">
                        Login
                    </button>
                </form>
            </div>

            <!-- User Dashboard -->
            <div id="userDashboard" class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6" style="display: none;">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Dashboard User</h2>
                        <p class="text-gray-600">Selamat datang, <span id="welcomeUser" class="font-medium"></span></p>
                    </div>
                    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-200">
                        Logout
                    </button>
                </div>

                <!-- Scanner Section -->
                <div class="scanner-container">
                    <h3 class="text-xl font-bold text-center mb-4 text-gray-800">Scan QR Code Absensi</h3>
                    <div class="bg-gray-100 rounded-lg p-4 mb-4">
                        <div id="qr-reader"></div>
                        <div class="text-center mt-4">
                            <button id="startScanBtn" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition duration-200 font-medium">
                                üì∑ Mulai Scan
                            </button>
                            <button id="stopScanBtn" class="bg-red-600 text-white px-6 py-2 rounded-md hover:bg-red-700 transition duration-200 font-medium ml-2" style="display: none;">
                                ‚èπÔ∏è Stop Scan
                            </button>
                        </div>
                    </div>
                    
                    <!-- Status Message -->
                    <div id="scanStatus" class="text-center p-4 rounded-md mb-4" style="display: none;"></div>
                </div>

                <!-- Riwayat Absensi -->
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Riwayat Absensi Hari Ini</h3>
                    <div id="attendanceHistory" class="bg-gray-50 rounded-lg p-4">
                        <p class="text-gray-600 text-center">Belum ada data absensi hari ini</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Tab Content -->
        <div id="adminContent" class="tab-content">
            <!-- Admin Login -->
            <div id="adminLoginForm" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Login Admin</h2>
                <form id="adminLogin">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Username Admin</label>
                        <input type="text" id="adminUsername" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="admin" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="adminPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="password" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-200 font-medium">
                        Login Admin
                    </button>
                </form>
                <p class="text-sm text-gray-500 text-center mt-4">Demo: admin / admin123</p>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6" style="display: none;">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard Admin</h2>
                    <button id="adminLogoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-200">
                        Logout
                    </button>
                </div>

                <!-- Admin Sub Tabs -->
                <div class="flex justify-center mb-6">
                    <div class="bg-gray-100 rounded-lg p-1">
                        <button id="attendanceSubTab" class="admin-sub-tab px-4 py-2 rounded-md font-medium transition-all duration-200 bg-indigo-600 text-white text-sm">
                            üìä Absensi
                        </button>
                        <button id="teacherSubTab" class="admin-sub-tab px-4 py-2 rounded-md font-medium transition-all duration-200 text-gray-600 hover:text-indigo-600 text-sm">
                            üë• Data Guru
                        </button>
                    </div>
                </div>

                <!-- Attendance Tab Content -->
                <div id="attendanceTabContent" class="admin-tab-content">
                    <!-- QR Code Generator -->
                    <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="qr-display">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">QR Code Absensi</h3>
                        <div id="qrCodeDisplay" class="mb-4">
                            <div class="w-48 h-48 mx-auto bg-white rounded-lg flex items-center justify-center border-2 border-gray-200">
                                <canvas id="qrCanvas" width="192" height="192"></canvas>
                            </div>
                        </div>
                        <button id="generateQRBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200 font-medium">
                            üîÑ Generate QR Baru
                        </button>
                        <p class="text-sm text-gray-600 mt-2">Berlaku: <span id="qrValidTime">-</span></p>
                    </div>

                    <!-- Quick Stats -->
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Statistik Hari Ini</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Hadir:</span>
                                <span id="totalPresent" class="font-bold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Waktu Terakhir:</span>
                                <span id="lastScanTime" class="font-medium text-gray-800">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status Sync:</span>
                                <span id="syncStatusBadge" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">Offline</span>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button id="loadDataBtn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-200 font-medium text-sm">
                                üì• Muat dari Sheets
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Data Absensi -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Data Absensi Hari Ini</h3>
                        <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200 font-medium">
                            üìä Export Data
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">No</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ID Guru</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama Lengkap</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Sekolah</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Kecamatan</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Waktu Absen</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTable">
                                <tr>
                                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">Belum ada data absensi</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>

                <!-- Teacher Management Tab Content -->
                <div id="teacherTabContent" class="admin-tab-content" style="display: none;">
                    <!-- Add Teacher Form -->
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Tambah Data Guru</h3>
                        <form id="addTeacherForm" class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Nama Lengkap</label>
                                <input type="text" id="teacherName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Nama lengkap guru" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Sekolah</label>
                                <input type="text" id="teacherSchool" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Nama sekolah" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Kecamatan</label>
                                <select id="teacherDistrict" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="">Pilih Kecamatan</option>
                                    <option value="Kecamatan A">Kecamatan A</option>
                                    <option value="Kecamatan B">Kecamatan B</option>
                                    <option value="Kecamatan C">Kecamatan C</option>
                                    <option value="Kecamatan D">Kecamatan D</option>
                                    <option value="Kecamatan E">Kecamatan E</option>
                                </select>
                            </div>
                            <div class="md:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition duration-200 font-medium">
                                    ‚ûï Tambah Guru
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Teacher Statistics -->
                    <div class="grid md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="totalTeachers">0</div>
                            <div class="text-sm text-gray-600">Total Guru</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600" id="activeTeachers">0</div>
                            <div class="text-sm text-gray-600">Aktif Hari Ini</div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="totalSchools">0</div>
                            <div class="text-sm text-gray-600">Sekolah</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600" id="totalDistricts">0</div>
                            <div class="text-sm text-gray-600">Kecamatan</div>
                        </div>
                    </div>

                    <!-- Teacher List -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Daftar Guru</h3>
                            <div class="flex gap-2">
                                <input type="text" id="searchTeacher" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Cari guru...">
                                <button id="exportTeachersBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200 font-medium">
                                    üìä Export Data
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ID Guru</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama Lengkap</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Sekolah</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Kecamatan</th>
                                    </tr>
                                </thead>
                                <tbody id="teacherTable">
                                    <tr>
                                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">Belum ada data guru</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentQRCode = null;
        let html5QrCode = null;
        let attendanceData = [];
        let teacherData = [];
        let isScanning = false;
        let teacherIdCounter = 1;
        
        // Google Apps Script Configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwlDAgK61zPcD6_gxk0rzZb4L5f-ggaKpgATkL3Ptj0P8aoE7aF7SHYr4HNkYkMhNx7/exec';
        let isOnline = navigator.onLine;

        // Network status monitoring
        window.addEventListener('online', () => {
            isOnline = true;
            loadDataFromGoogleSheets();
            showSyncStatus('üåê Koneksi tersambung', 'success');
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            showSyncStatus('üì± Tidak ada koneksi internet', 'warning');
        });

        // Google Sheets Integration Functions
        async function syncToGoogleSheets(data, type) {
            if (!isOnline) {
                showSyncStatus('üì± Tidak ada koneksi internet', 'error');
                return false;
            }

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: type === 'teacher' ? 'addTeacher' : 'addAttendance',
                        data: data
                    })
                });
                
                showSyncStatus('‚úÖ Data berhasil disimpan ke Google Sheets', 'success');
                
                // Reload data after successful sync
                setTimeout(() => {
                    loadDataFromGoogleSheets();
                }, 1000);
                
                return true;
            } catch (error) {
                console.error('Sync error:', error);
                showSyncStatus('‚ö†Ô∏è Gagal menyimpan data ke Google Sheets', 'error');
                return false;
            }
        }

        async function loadDataFromGoogleSheets() {
            if (!isOnline) {
                showSyncStatus('üì± Tidak ada koneksi internet', 'warning');
                return;
            }

            try {
                showSyncStatus('üîÑ Memuat data dari Google Sheets...', 'info');
                
                // Load teachers data from Google Sheets
                const teachersResponse = await fetch(`${GOOGLE_SCRIPT_URL}?action=getTeachers`);
                if (teachersResponse.ok) {
                    const teachers = await teachersResponse.json();
                    teacherData = teachers || [];
                    
                    // Update counter based on existing data
                    if (teacherData.length > 0) {
                        const maxId = Math.max(...teacherData.map(t => parseInt(t.id.replace('GR', ''))));
                        teacherIdCounter = maxId + 1;
                    }
                }
                
                // Load attendance data from Google Sheets
                const attendanceResponse = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAttendance`);
                if (attendanceResponse.ok) {
                    const attendance = await attendanceResponse.json();
                    attendanceData = attendance || [];
                }
                
                updateTeacherStats();
                updateTeacherTable();
                updateAdminStats();
                updateAttendanceTable();
                
                showSyncStatus('‚úÖ Data berhasil dimuat dari Google Sheets', 'success');
            } catch (error) {
                console.error('Load error:', error);
                showSyncStatus('‚ö†Ô∏è Gagal memuat data dari Google Sheets', 'error');
            }
        }

        function showSyncStatus(message, type) {
            // Create or update sync status indicator
            let syncIndicator = document.getElementById('syncIndicator');
            if (!syncIndicator) {
                syncIndicator = document.createElement('div');
                syncIndicator.id = 'syncIndicator';
                syncIndicator.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg text-sm font-medium z-50 transition-all duration-300';
                document.body.appendChild(syncIndicator);
            }

            syncIndicator.textContent = message;
            syncIndicator.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg text-sm font-medium z-50 transition-all duration-300';
            
            if (type === 'success') {
                syncIndicator.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
            } else if (type === 'error') {
                syncIndicator.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
            } else if (type === 'warning') {
                syncIndicator.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-200');
            } else {
                syncIndicator.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-200');
            }

            // Auto hide after 3 seconds
            setTimeout(() => {
                if (syncIndicator) {
                    syncIndicator.style.opacity = '0';
                    setTimeout(() => {
                        if (syncIndicator && syncIndicator.parentNode) {
                            syncIndicator.parentNode.removeChild(syncIndicator);
                        }
                    }, 300);
                }
            }, 3000);
        }

        // Tab functionality
        document.getElementById('userTab').addEventListener('click', () => switchTab('user'));
        document.getElementById('adminTab').addEventListener('click', () => switchTab('admin'));
        
        // Admin sub-tab functionality
        document.getElementById('attendanceSubTab').addEventListener('click', () => switchAdminTab('attendance'));
        document.getElementById('teacherSubTab').addEventListener('click', () => switchAdminTab('teacher'));

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-gray-600');
            });
            
            if (tab === 'user') {
                document.getElementById('userTab').classList.add('bg-indigo-600', 'text-white');
                document.getElementById('userTab').classList.remove('text-gray-600');
                document.getElementById('userContent').classList.add('active');
                document.getElementById('adminContent').classList.remove('active');
            } else {
                document.getElementById('adminTab').classList.add('bg-indigo-600', 'text-white');
                document.getElementById('adminTab').classList.remove('text-gray-600');
                document.getElementById('adminContent').classList.add('active');
                document.getElementById('userContent').classList.remove('active');
            }
        }

        function switchAdminTab(tab) {
            // Update admin sub-tab buttons
            document.querySelectorAll('.admin-sub-tab').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-gray-600');
            });
            
            if (tab === 'attendance') {
                document.getElementById('attendanceSubTab').classList.add('bg-indigo-600', 'text-white');
                document.getElementById('attendanceSubTab').classList.remove('text-gray-600');
                document.getElementById('attendanceTabContent').style.display = 'block';
                document.getElementById('teacherTabContent').style.display = 'none';
            } else if (tab === 'teacher') {
                document.getElementById('teacherSubTab').classList.add('bg-indigo-600', 'text-white');
                document.getElementById('teacherSubTab').classList.remove('text-gray-600');
                document.getElementById('attendanceTabContent').style.display = 'none';
                document.getElementById('teacherTabContent').style.display = 'block';
                updateTeacherStats();
                updateTeacherTable();
            }
        }

        // User login
        document.getElementById('userLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const userId = document.getElementById('userId').value.trim();
            
            if (userId) {
                currentUser = userId;
                document.getElementById('welcomeUser').textContent = userId;
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('userDashboard').style.display = 'block';
                updateUserAttendanceHistory();
            }
        });

        // User logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            currentUser = null;
            document.getElementById('userId').value = '';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('userDashboard').style.display = 'none';
            stopScanning();
        });

        // Admin login
        document.getElementById('adminLogin').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (username === 'admin' && password === 'admin123') {
                document.getElementById('adminLoginForm').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                generateQRCode();
                updateAdminStats();
                updateAttendanceTable();
            } else {
                alert('Username atau password salah!');
            }
        });

        // Admin logout
        document.getElementById('adminLogoutBtn').addEventListener('click', function() {
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLoginForm').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
        });

        // QR Code Scanner
        document.getElementById('startScanBtn').addEventListener('click', startScanning);
        document.getElementById('stopScanBtn').addEventListener('click', stopScanning);

        function startScanning() {
            if (!currentUser) {
                showScanStatus('Silakan login terlebih dahulu!', 'error');
                return;
            }

            html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                async (decodedText, decodedResult) => {
                    console.log('QR Code detected:', decodedText);
                    
                    // Check if it's a valid KKG attendance QR code
                    if (decodedText.startsWith('ABSEN_KKG_')) {
                        // Extract date from QR code
                        const qrParts = decodedText.split('_');
                        if (qrParts.length >= 3) {
                            const qrDate = qrParts[2]; // Get date part
                            const today = new Date().toLocaleDateString('id-ID');
                            
                            // Check if QR code is for today
                            if (qrDate === today) {
                                await recordAttendance(currentUser);
                                stopScanning();
                            } else {
                                showScanStatus('QR Code sudah kadaluarsa atau bukan untuk hari ini!', 'error');
                            }
                        } else {
                            showScanStatus('Format QR Code tidak valid!', 'error');
                        }
                    } else {
                        showScanStatus('QR Code bukan untuk absensi KKG!', 'error');
                    }
                },
                (errorMessage) => {
                    // Handle scan error silently
                }
            ).then(() => {
                isScanning = true;
                document.getElementById('startScanBtn').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'inline-block';
                showScanStatus('Scanning... Arahkan kamera ke QR Code', 'info');
            }).catch(err => {
                showScanStatus('Tidak dapat mengakses kamera. Pastikan izin kamera diberikan.', 'error');
            });
        }

        function stopScanning() {
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    document.getElementById('startScanBtn').style.display = 'inline-block';
                    document.getElementById('stopScanBtn').style.display = 'none';
                    document.getElementById('scanStatus').style.display = 'none';
                }).catch(err => {
                    console.log('Error stopping scanner:', err);
                });
            }
        }

        function showScanStatus(message, type) {
            const statusEl = document.getElementById('scanStatus');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            statusEl.className = 'text-center p-4 rounded-md mb-4';
            if (type === 'success') {
                statusEl.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                statusEl.classList.add('bg-red-100', 'text-red-800');
            } else {
                statusEl.classList.add('bg-blue-100', 'text-blue-800');
            }
        }

        // QR Code Generation
        document.getElementById('generateQRBtn').addEventListener('click', generateQRCode);

        function generateQRCode() {
            const timestamp = new Date().getTime();
            const date = new Date().toLocaleDateString('id-ID');
            currentQRCode = `ABSEN_KKG_${date}_${timestamp}`;
            
            // Clear previous QR code
            const qrDisplay = document.getElementById('qrCodeDisplay');
            qrDisplay.innerHTML = '<div class="w-48 h-48 mx-auto bg-white rounded-lg flex items-center justify-center border-2 border-gray-200"><div class="text-gray-500">Generating QR...</div></div>';
            
            // Generate QR code using online API
            const qrSize = 200;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(currentQRCode)}&format=png&margin=10`;
            
            // Create image element
            const qrImage = document.createElement('img');
            qrImage.src = qrUrl;
            qrImage.alt = 'QR Code Absensi';
            qrImage.className = 'w-48 h-48 mx-auto rounded-lg border-2 border-gray-200';
            qrImage.style.imageRendering = 'pixelated'; // Keep QR code crisp
            
            qrImage.onload = function() {
                qrDisplay.innerHTML = '';
                qrDisplay.appendChild(qrImage);
                console.log('QR Code generated successfully');
            };
            
            qrImage.onerror = function() {
                console.log('Failed to load QR from API, using SVG fallback');
                generateSVGQRCode();
            };
            
            const validTime = new Date();
            validTime.setHours(validTime.getHours() + 1);
            document.getElementById('qrValidTime').textContent = validTime.toLocaleTimeString('id-ID');
        }
        
        function generateSVGQRCode() {
            // Fallback SVG QR code generator
            const qrDisplay = document.getElementById('qrCodeDisplay');
            const size = 192;
            const modules = 25; // QR code grid size
            const moduleSize = size / modules;
            
            // Simple QR code pattern generator
            const qrData = generateQRPattern(modules);
            
            let svgContent = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg" class="border-2 border-gray-200 rounded-lg">`;
            svgContent += `<rect width="${size}" height="${size}" fill="white"/>`;
            
            for (let row = 0; row < modules; row++) {
                for (let col = 0; col < modules; col++) {
                    if (qrData[row][col]) {
                        const x = col * moduleSize;
                        const y = row * moduleSize;
                        svgContent += `<rect x="${x}" y="${y}" width="${moduleSize}" height="${moduleSize}" fill="black"/>`;
                    }
                }
            }
            
            svgContent += '</svg>';
            qrDisplay.innerHTML = svgContent;
        }
        
        function generateQRPattern(size) {
            // Create a simple QR-like pattern
            const pattern = Array(size).fill().map(() => Array(size).fill(false));
            
            // Add finder patterns (corner squares)
            addFinderPattern(pattern, 0, 0);
            addFinderPattern(pattern, 0, size - 7);
            addFinderPattern(pattern, size - 7, 0);
            
            // Add timing patterns
            for (let i = 8; i < size - 8; i++) {
                pattern[6][i] = i % 2 === 0;
                pattern[i][6] = i % 2 === 0;
            }
            
            // Add some data pattern
            for (let row = 9; row < size - 9; row++) {
                for (let col = 9; col < size - 9; col++) {
                    if (!pattern[row][col]) {
                        // Create a pseudo-random pattern based on position and current QR code
                        const hash = (row * 31 + col * 17 + currentQRCode.length) % 100;
                        pattern[row][col] = hash > 50;
                    }
                }
            }
            
            return pattern;
        }
        
        function addFinderPattern(pattern, startRow, startCol) {
            // 7x7 finder pattern
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    const r = startRow + row;
                    const c = startCol + col;
                    if (r < pattern.length && c < pattern[0].length) {
                        // Outer border
                        if (row === 0 || row === 6 || col === 0 || col === 6) {
                            pattern[r][c] = true;
                        }
                        // Inner square
                        else if (row >= 2 && row <= 4 && col >= 2 && col <= 4) {
                            pattern[r][c] = true;
                        }
                        // White space
                        else {
                            pattern[r][c] = false;
                        }
                    }
                }
            }
        }

        // Attendance recording
        async function recordAttendance(userId) {
            const now = new Date();
            const attendance = {
                id: attendanceData.length + 1,
                userId: userId,
                timestamp: now.toISOString(),
                date: now.toLocaleDateString('id-ID'),
                time: now.toLocaleTimeString('id-ID')
            };
            
            // Check if user already attended today
            const today = now.toLocaleDateString('id-ID');
            const alreadyAttended = attendanceData.some(record => 
                record.userId === userId && record.date === today
            );
            
            if (alreadyAttended) {
                showScanStatus('Anda sudah absen hari ini!', 'error');
                return;
            }
            
            // Add to local data first
            attendanceData.push(attendance);
            
            // Sync to Google Sheets
            const syncSuccess = await syncToGoogleSheets(attendance, 'attendance');
            
            if (syncSuccess) {
                showScanStatus('‚úÖ Absensi berhasil dicatat!', 'success');
                updateUserAttendanceHistory();
                updateAdminStats();
                updateAttendanceTable();
            } else {
                showScanStatus('‚ùå Gagal mencatat absensi!', 'error');
            }
        }

        function updateUserAttendanceHistory() {
            if (!currentUser) return;
            
            const today = new Date().toLocaleDateString('id-ID');
            const userAttendance = attendanceData.filter(record => 
                record.userId === currentUser && record.date === today
            );
            
            const historyEl = document.getElementById('attendanceHistory');
            if (userAttendance.length === 0) {
                historyEl.innerHTML = '<p class="text-gray-600 text-center">Belum ada data absensi hari ini</p>';
            } else {
                historyEl.innerHTML = userAttendance.map(record => `
                    <div class="bg-white rounded-lg p-4 border-l-4 border-green-500">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-800">Hadir</span>
                            <span class="text-sm text-gray-600">${record.time}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateAdminStats() {
            const today = new Date().toLocaleDateString('id-ID');
            const todayAttendance = attendanceData.filter(record => record.date === today);
            
            document.getElementById('totalPresent').textContent = todayAttendance.length;
            
            if (todayAttendance.length > 0) {
                const lastAttendance = todayAttendance[todayAttendance.length - 1];
                document.getElementById('lastScanTime').textContent = lastAttendance.time;
            } else {
                document.getElementById('lastScanTime').textContent = '-';
            }
        }

        function updateAttendanceTable() {
            const today = new Date().toLocaleDateString('id-ID');
            const todayAttendance = attendanceData.filter(record => record.date === today);
            
            const tableBody = document.getElementById('attendanceTable');
            
            if (todayAttendance.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Belum ada data absensi</td></tr>';
            } else {
                tableBody.innerHTML = todayAttendance.map((record, index) => {
                    // Find teacher data
                    const teacher = teacherData.find(t => t.id === record.userId);
                    const teacherName = teacher ? teacher.name : 'Tidak Diketahui';
                    const teacherSchool = teacher ? teacher.school : '-';
                    const teacherDistrict = teacher ? teacher.district : '-';
                    
                    return `
                        <tr class="border-t border-gray-200">
                            <td class="px-4 py-3 text-sm text-gray-900">${index + 1}</td>
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${record.userId}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">${teacherName}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">${teacherSchool}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">${teacherDistrict}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">${record.time}</td>
                            <td class="px-4 py-3">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    Hadir
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Teacher management
        document.getElementById('addTeacherForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('teacherName').value.trim();
            const school = document.getElementById('teacherSchool').value.trim();
            const district = document.getElementById('teacherDistrict').value;
            
            if (name && school && district) {
                const teacherId = `GR${String(teacherIdCounter).padStart(4, '0')}`;
                
                const teacher = {
                    id: teacherId,
                    name: name,
                    school: school,
                    district: district,
                    createdAt: new Date().toISOString(),
                    isActive: false
                };
                
                // Add to local data first
                teacherData.push(teacher);
                teacherIdCounter++;
                
                // Sync to Google Sheets
                const syncSuccess = await syncToGoogleSheets(teacher, 'teacher');
                
                if (syncSuccess) {
                    // Reset form
                    document.getElementById('addTeacherForm').reset();
                    
                    // Update displays
                    updateTeacherStats();
                    updateTeacherTable();
                    
                    alert(`Guru berhasil ditambahkan dengan ID: ${teacherId}`);
                } else {
                    alert('Gagal menambahkan guru. Periksa koneksi internet.');
                }
            }
        });

        // Search teacher
        document.getElementById('searchTeacher').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            updateTeacherTable(searchTerm);
        });

        // Export teachers
        document.getElementById('exportTeachersBtn').addEventListener('click', function() {
            if (teacherData.length === 0) {
                alert('Tidak ada data guru untuk diekspor');
                return;
            }
            
            let csvContent = "ID Guru,Nama Lengkap,Sekolah,Kecamatan,Status,Tanggal Dibuat\n";
            teacherData.forEach(teacher => {
                const status = teacher.isActive ? 'Aktif' : 'Tidak Aktif';
                const date = new Date(teacher.createdAt).toLocaleDateString('id-ID');
                csvContent += `${teacher.id},"${teacher.name}","${teacher.school}","${teacher.district}",${status},${date}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `data_guru_kkg_${new Date().toLocaleDateString('id-ID').replace(/\//g, '-')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        });

        function updateTeacherStats() {
            const today = new Date().toLocaleDateString('id-ID');
            const activeTeachers = attendanceData.filter(record => record.date === today);
            const uniqueSchools = [...new Set(teacherData.map(teacher => teacher.school))];
            const uniqueDistricts = [...new Set(teacherData.map(teacher => teacher.district))];
            
            document.getElementById('totalTeachers').textContent = teacherData.length;
            document.getElementById('activeTeachers').textContent = activeTeachers.length;
            document.getElementById('totalSchools').textContent = uniqueSchools.length;
            document.getElementById('totalDistricts').textContent = uniqueDistricts.length;
        }

        function updateTeacherTable(searchTerm = '') {
            const filteredTeachers = teacherData.filter(teacher => 
                teacher.name.toLowerCase().includes(searchTerm) ||
                teacher.id.toLowerCase().includes(searchTerm) ||
                teacher.school.toLowerCase().includes(searchTerm) ||
                teacher.district.toLowerCase().includes(searchTerm)
            );
            
            const tableBody = document.getElementById('teacherTable');
            
            if (filteredTeachers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Tidak ada data guru</td></tr>';
            } else {
                tableBody.innerHTML = filteredTeachers.map(teacher => {
                    return `
                        <tr class="border-t border-gray-200">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${teacher.id}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">${teacher.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">${teacher.school}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">${teacher.district}</td>
                        </tr>
                    `;
                }).join('');
            }
        }



        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', function() {
            const today = new Date().toLocaleDateString('id-ID');
            const todayAttendance = attendanceData.filter(record => record.date === today);
            
            if (todayAttendance.length === 0) {
                alert('Tidak ada data untuk diekspor');
                return;
            }
            
            let csvContent = "No,ID Guru,Nama Lengkap,Sekolah,Kecamatan,Tanggal,Waktu,Status\n";
            todayAttendance.forEach((record, index) => {
                const teacher = teacherData.find(t => t.id === record.userId);
                const teacherName = teacher ? teacher.name : 'Tidak Diketahui';
                const teacherSchool = teacher ? teacher.school : '-';
                const teacherDistrict = teacher ? teacher.district : '-';
                
                csvContent += `${index + 1},${record.userId},"${teacherName}","${teacherSchool}","${teacherDistrict}",${record.date},${record.time},Hadir\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `absensi_kkg_${today.replace(/\//g, '-')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        });

        // Manual sync buttons
        document.getElementById('loadDataBtn').addEventListener('click', function() {
            loadDataFromGoogleSheets();
        });

        // Update sync status badge
        function updateSyncStatusBadge() {
            const badge = document.getElementById('syncStatusBadge');
            
            if (isOnline) {
                badge.textContent = 'Online';
                badge.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-600';
            } else {
                badge.textContent = 'Offline';
                badge.className = 'text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600';
            }
        }

        // Initialize
        updateAdminStats();
        updateAttendanceTable();
        updateTeacherStats();
        updateTeacherTable();
        updateSyncStatusBadge();
        
        // Generate QR code after page loads and libraries are ready
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof QRCode !== 'undefined') {
                    generateQRCode();
                } else {
                    console.log('QRCode library not loaded yet, retrying...');
                    setTimeout(generateQRCode, 1000);
                }
            }, 1000);
        });
        
        // Load data from Google Sheets on startup
        if (isOnline) {
            loadDataFromGoogleSheets();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98c27dd695da9faa',t:'MTc2MDA2MTI4NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
