<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Hadir KKG PAI Binaan - Dewi Yuliani, S.Ag, MA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        #video {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 12px;
        }
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #10b981;
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-blue-50 min-h-full">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="text-center">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">ğŸ“š Daftar Hadir KKG PAI Binaan</h1>
                <p class="text-lg text-emerald-600 font-semibold">Dewi Yuliani, S.Ag, MA</p>
                <p class="text-sm text-gray-600">Pengawas PAI</p>
                <div class="mt-4 p-3 bg-emerald-50 rounded-lg">
                    <p class="text-sm text-emerald-700" id="currentDate"></p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex flex-wrap gap-2 mb-6">
                <button id="attendanceTab" class="tab-btn active px-4 py-2 rounded-lg font-semibold transition-colors bg-emerald-600 text-white">
                    ğŸ“‹ Kehadiran
                </button>
                <button id="teacherDataTab" class="tab-btn px-4 py-2 rounded-lg font-semibold transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 hidden">
                    ğŸ‘¥ Data Guru PAI
                </button>
                <button id="adminTab" class="tab-btn px-4 py-2 rounded-lg font-semibold transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                    ğŸ” Admin Login
                </button>
            </div>
        </div>

        <!-- Attendance Tab Content -->
        <div id="attendanceContent">
            <!-- Scanner Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">ğŸ“± Scan QR Code Kehadiran</h2>
            
                <div class="scanner-container mb-4">
                    <video id="video" autoplay muted playsinline style="display: none;"></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div class="scanner-overlay pulse" id="scannerOverlay" style="display: none;"></div>
                    
                    <div id="scannerPlaceholder" class="bg-gray-100 rounded-xl h-72 flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-6xl mb-4">ğŸ“·</div>
                            <button id="startScanBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                Mulai Scan QR Code
                            </button>
                        </div>
                    </div>
                </div>

                <div id="scanResult" class="hidden p-4 rounded-lg mb-4"></div>
                
                <!-- Debug Info -->
                <div id="debugInfo" class="text-xs text-gray-500 text-center mb-4 hidden">
                    <p>Debug: <span id="debugText">Menunggu...</span></p>
                    <p>Library jsQR: <span id="jsqrStatus">Checking...</span></p>
                    <p>Video: <span id="videoStatus">Not started</span></p>
                </div>
                
                <div class="text-center">
                    <button id="stopScanBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors hidden">
                        Berhenti Scan
                    </button>
                    <button id="toggleDebugBtn" class="ml-2 bg-gray-400 hover:bg-gray-500 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                        ğŸ” Debug
                    </button>
                </div>
            </div>

            <!-- Manual Entry -->
            <div id="manualEntrySection" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">âœï¸ Input Data Kehadiran</h3>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-emerald-600 font-medium">ğŸ‘¤ Admin: <span id="loggedInUser"></span></span>
                        <button id="logoutBtn" class="text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg transition-colors">
                            ğŸšª Logout
                        </button>
                    </div>
                </div>
                <form id="manualForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="text-red-500">*</span> Nama Lengkap
                            </label>
                            <select id="manualName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                <option value="">Pilih nama guru...</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Pilih nama dari database guru PAI</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="text-red-500">*</span> Nama Sekolah
                            </label>
                            <input type="text" id="manualSchool" required readonly class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Akan terisi otomatis">
                            <p class="text-xs text-gray-500 mt-1">Terisi otomatis setelah memilih nama</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="text-red-500">*</span> Kecamatan
                            </label>
                            <input type="text" id="manualDistrict" required readonly class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Akan terisi otomatis">
                            <p class="text-xs text-gray-500 mt-1">Terisi otomatis setelah memilih nama</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="text-red-500">*</span> Status Kehadiran
                            </label>
                            <select id="attendanceStatus" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                <option value="">Pilih status kehadiran</option>
                                <option value="Hadir">âœ… Hadir</option>
                                <option value="Sakit">ğŸ¤’ Sakit</option>
                                <option value="Izin">ğŸ“ Izin</option>
                                <option value="Alpha">âŒ Alpha</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Pilih status kehadiran peserta</p>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2">
                            <span>âœ…</span> Tambah Kehadiran
                        </button>
                        <button type="button" id="clearFormBtn" class="px-6 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-semibold transition-colors">
                            ğŸ—‘ï¸ Bersihkan
                        </button>
                    </div>
                </form>
            </div>

            <!-- Attendance List -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">ğŸ“‹ Daftar Kehadiran</h3>
                    <div class="text-sm text-gray-600">
                        <div class="flex flex-wrap gap-2">
                            <span>Total: <span id="totalCount" class="font-semibold text-emerald-600">0</span></span>
                            <span class="text-green-600">âœ… <span id="hadirCount">0</span></span>
                            <span class="text-yellow-600">ğŸ¤’ <span id="sakitCount">0</span></span>
                            <span class="text-blue-600">ğŸ“ <span id="izinCount">0</span></span>
                            <span class="text-red-600">âŒ <span id="alphaCount">0</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">No</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Nama Lengkap</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Sekolah</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Kecamatan</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Status</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Waktu Input</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Metode</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceList">
                            <!-- Attendance records will be added here -->
                        </tbody>
                    </table>
                    
                    <div id="emptyState" class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">ğŸ“</div>
                        <p>Belum ada peserta yang hadir</p>
                        <p class="text-sm">Scan QR Code atau input manual untuk menambah kehadiran</p>
                    </div>
                </div>
            </div>

            <!-- Export Button -->
            <div class="mt-6 text-center">
                <button id="exportBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    ğŸ“Š Export Daftar Hadir
                </button>
            </div>
        </div>

        <!-- Admin Tab Content -->
        <div id="adminContent" class="hidden">
            <!-- Admin Login -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ” Login Admin</h3>
                <p class="text-sm text-gray-600 mb-4">Masuk sebagai admin untuk mengakses fitur input manual kehadiran dan manajemen data guru</p>
                
                <div id="loginSection">
                    <form id="loginForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username Admin</label>
                            <input type="text" id="adminUsername" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="Masukkan username admin">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="adminPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="Masukkan password">
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                ğŸ”“ Login Admin
                            </button>
                        </div>
                    </form>
                    <div id="loginError" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
                </div>

                <div id="adminDashboard" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">ğŸ‘‹ Selamat Datang, Admin!</h4>
                            <p class="text-sm text-emerald-600 font-medium">Login sebagai: <span id="loggedInUserDisplay"></span></p>
                        </div>
                        <button id="logoutBtnMain" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            ğŸšª Logout
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-emerald-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-emerald-800 mb-2">ğŸ“‹ Fitur Kehadiran</h5>
                            <p class="text-sm text-emerald-700 mb-3">Kelola data kehadiran peserta KKG PAI</p>
                            <button onclick="switchTab('attendance')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                                Buka Kehadiran
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-blue-800 mb-2">ğŸ‘¥ Data Guru PAI</h5>
                            <p class="text-sm text-blue-700 mb-3">Kelola database guru PAI</p>
                            <button onclick="switchTab('teacherData')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                                Buka Data Guru
                            </button>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-purple-800 mb-2">ğŸ“Š Google Sheets</h5>
                            <p class="text-sm text-purple-700 mb-3">Sinkronisasi data ke spreadsheet</p>
                            <button onclick="openSheetsModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                                Setup Sheets
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h5 class="font-semibold text-gray-800 mb-2">â„¹ï¸ Informasi Admin</h5>
                        <div class="text-sm text-gray-600 space-y-1">
                            <p>â€¢ Sebagai admin, Anda dapat menginput kehadiran secara manual</p>
                            <p>â€¢ Anda dapat mengelola data guru PAI (tambah, edit, hapus)</p>
                            <p>â€¢ Semua data dapat diekspor ke format CSV</p>
                            <p>â€¢ Data dapat disinkronkan ke Google Sheets secara otomatis</p>
                            <p>â€¢ Pastikan logout setelah selesai menggunakan sistem</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Data Tab Content -->
        <div id="teacherDataContent" class="hidden">
            <!-- Teacher Data Management -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">ğŸ‘¥ Data Guru PAI</h3>
                    <button id="addTeacherBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                        â• Tambah Guru
                    </button>
                </div>
                
                <!-- Teacher Form -->
                <div id="teacherFormSection" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="text-md font-semibold text-gray-800 mb-4">ğŸ“ Form Data Guru</h4>
                    <form id="teacherForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <span class="text-red-500">*</span> Nama Lengkap
                                </label>
                                <input type="text" id="teacherName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="Contoh: Ahmad Budi Santoso, S.Pd.I">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <span class="text-red-500">*</span> Nama Sekolah
                                </label>
                                <input type="text" id="teacherSchool" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="Contoh: SDN 01 Sukamaju">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <span class="text-red-500">*</span> Kecamatan
                                </label>
                                <input type="text" id="teacherDistrict" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="Contoh: Sukamaju">
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                âœ… Simpan Data
                            </button>
                            <button type="button" id="cancelTeacherBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                âŒ Batal
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Teacher List -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">No</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Nama Lengkap</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Sekolah</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Kecamatan</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="teacherList">
                            <!-- Teacher records will be added here -->
                        </tbody>
                    </table>
                    
                    <div id="teacherEmptyState" class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">ğŸ‘¥</div>
                        <p>Belum ada data guru PAI</p>
                        <p class="text-sm">Klik "Tambah Guru" untuk menambah data guru</p>
                    </div>
                </div>

                <!-- Teacher Export Button -->
                <div class="mt-6 text-center">
                    <button id="exportTeacherBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        ğŸ“Š Export Data Guru
                    </button>
                </div>
            </div>
        </div>

        <!-- Google Sheets Modal -->
        <div id="sheetsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-full overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">ğŸ“Š Setup Google Sheets Integration</h3>
                        <button id="closeSheetsModal" class="text-gray-500 hover:text-gray-700 text-2xl">
                            âœ•
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Status Section -->
                        <div id="sheetsStatus" class="p-4 rounded-lg bg-gray-50">
                            <h4 class="font-semibold text-gray-800 mb-2">ğŸ“‹ Status Konfigurasi</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Sheet Kehadiran:</span>
                                    <span id="attendanceSheetStatus" class="text-red-600">âŒ Belum dikonfigurasi</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Sheet Data Guru:</span>
                                    <span id="teacherSheetStatus" class="text-red-600">âŒ Belum dikonfigurasi</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Auto-Sync:</span>
                                    <span id="autoSyncStatus" class="text-red-600">âŒ Nonaktif</span>
                                </div>
                            </div>
                        </div>

                        <!-- Instructions -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-3">ğŸ“ Panduan Setup Google Sheets</h4>
                            <div class="text-sm text-blue-700 space-y-3">
                                <div>
                                    <strong>Langkah 1: Buat Google Sheets</strong>
                                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                        <li>Buat 2 spreadsheet baru: "Data Kehadiran KKG PAI" dan "Data Guru PAI"</li>
                                        <li>Di sheet kehadiran, buat header: <code class="bg-white px-1 rounded">No | Nama Lengkap | Sekolah | Kecamatan | Status Kehadiran | Waktu Input | Metode Input | Tanggal | Admin Input | Catatan</code></li>
                                        <li>Di sheet guru, buat header: <code class="bg-white px-1 rounded">No | Nama Lengkap | Sekolah | Kecamatan | Tanggal Input | Admin Input | Status</code></li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <strong>Langkah 2: Set Sharing</strong>
                                    <ul class="list-disc list-inside ml-4 mt-1">
                                        <li>Klik "Share" â†’ Pilih "Anyone with the link can edit"</li>
                                        <li>Copy URL dari address bar browser</li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <strong>Langkah 3: Paste URL ke form di bawah</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Configuration Form -->
                        <form id="sheetsConfigForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ğŸ“‹ URL Google Sheets - Data Kehadiran
                                </label>
                                <input type="url" id="attendanceSheetUrl" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" placeholder="https://docs.google.com/spreadsheets/d/...">
                                <p class="text-xs text-gray-500 mt-1">Paste URL Google Sheets untuk menyimpan data kehadiran</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ğŸ‘¥ URL Google Sheets - Data Guru PAI
                                </label>
                                <input type="url" id="teacherSheetUrl" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" placeholder="https://docs.google.com/spreadsheets/d/...">
                                <p class="text-xs text-gray-500 mt-1">Paste URL Google Sheets untuk menyimpan data guru PAI</p>
                            </div>

                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="enableAutoSync" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                <label for="enableAutoSync" class="text-sm font-medium text-gray-700">
                                    ğŸ”„ Aktifkan sinkronisasi otomatis (data akan disiapkan untuk copy-paste)
                                </label>
                            </div>

                            <div class="flex gap-3">
                                <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                    ğŸ’¾ Simpan Konfigurasi
                                </button>
                                <button type="button" id="testSheetsBtn" class="px-6 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                    ğŸ§ª Test URL
                                </button>
                            </div>
                        </form>

                        <!-- Quick Actions -->
                        <div class="border-t pt-4">
                            <h4 class="font-semibold text-gray-800 mb-3">âš¡ Aksi Cepat</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="syncAllToSheets()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                                    ğŸ“¤ Siapkan Data untuk Copy
                                </button>
                                <button onclick="openSheetsInNewTab()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                                    ğŸ”— Buka Google Sheets
                                </button>
                            </div>
                        </div>

                        <!-- Copy Instructions -->
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-yellow-800 mb-2">ğŸ“‹ Cara Copy Data ke Google Sheets</h4>
                            <div class="text-sm text-yellow-700 space-y-1">
                                <p>1. Klik "Siapkan Data untuk Copy" untuk menyiapkan data</p>
                                <p>2. Klik "Copy Data" pada notifikasi yang muncul</p>
                                <p>3. Buka Google Sheets dengan klik "Buka Google Sheets"</p>
                                <p>4. Pilih cell A2 (baris kedua) di sheet yang sesuai</p>
                                <p>5. Tekan Ctrl+V (Windows) atau Cmd+V (Mac) untuk paste</p>
                                <p>6. Data akan otomatis tersusun sesuai kolom header</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sync Notification -->
        <div id="syncNotification" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg border-l-4 border-purple-500 p-4 z-50 hidden max-w-sm">
            <div class="flex items-start gap-3">
                <div class="text-purple-500 text-xl">ğŸ“Š</div>
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-800 text-sm">Data Siap untuk Google Sheets!</h4>
                    <p id="syncNotificationText" class="text-xs text-gray-600 mb-2"></p>
                    <div class="flex gap-2">
                        <button onclick="copySyncData()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs font-semibold transition-colors">
                            ğŸ“‹ Copy Data
                        </button>
                        <button onclick="openSheetsInNewTab()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs font-semibold transition-colors">
                            ğŸ”— Buka Sheet
                        </button>
                        <button onclick="hideSyncNotification()" class="text-gray-500 hover:text-gray-700 px-2 py-1 text-xs">
                            âœ•
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barcode Modal -->
        <div id="barcodeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-full overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">ğŸ“± QR Code Kehadiran</h3>
                        <button id="closeBarcodeModal" class="text-gray-500 hover:text-gray-700 text-2xl">
                            âœ•
                        </button>
                    </div>
                    
                    <div class="text-center mb-4">
                        <div id="teacherInfo" class="bg-emerald-50 p-4 rounded-lg mb-4">
                            <h4 id="barcodeTeacherName" class="font-semibold text-emerald-800"></h4>
                            <p id="barcodeTeacherSchool" class="text-sm text-emerald-600"></p>
                            <p id="barcodeTeacherDistrict" class="text-sm text-emerald-600"></p>
                        </div>
                        
                        <div id="barcodeContainer" class="bg-white p-4 rounded-lg border-2 border-gray-200 mb-4 flex justify-center">
                            <canvas id="barcodeCanvas" style="max-width: 100%; height: auto;"></canvas>
                        </div>
                        
                        <p class="text-xs text-gray-500 mb-4">
                            Scan QR Code ini dengan kamera HP untuk mencatat kehadiran secara otomatis
                        </p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="downloadBarcode" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-semibold transition-colors">
                            ğŸ’¾ Download QR Code
                        </button>
                        <button id="printBarcode" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition-colors">
                            ğŸ–¨ï¸ Print QR Code
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stream = null;
        let scanning = false;
        let attendanceData = [];
        let teacherData = [];
        let isAdminLoggedIn = false;
        let currentAdmin = '';
        let editingTeacherId = null;

        // Google Sheets Integration
        let sheetsConfig = {
            attendanceSheetUrl: '',
            teacherSheetUrl: '',
            autoSync: false
        };

        let pendingSyncData = null;

        // Admin credentials (in real app, this should be secured)
        const adminCredentials = {
            'admin': 'admin123',
            'dewi': 'dewi2024',
            'pengawas': 'pai123'
        };

        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('id-ID', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Load sheets configuration from localStorage
        function loadSheetsConfig() {
            const saved = localStorage.getItem('kkgPaiSheetsConfig');
            if (saved) {
                sheetsConfig = JSON.parse(saved);
                updateSheetsStatus();
            }
        }

        // Save sheets configuration to localStorage
        function saveSheetsConfig() {
            localStorage.setItem('kkgPaiSheetsConfig', JSON.stringify(sheetsConfig));
            updateSheetsStatus();
        }

        // Update sheets status display
        function updateSheetsStatus() {
            const attendanceStatus = document.getElementById('attendanceSheetStatus');
            const teacherStatus = document.getElementById('teacherSheetStatus');
            const autoSyncStatus = document.getElementById('autoSyncStatus');

            if (sheetsConfig.attendanceSheetUrl) {
                attendanceStatus.textContent = 'âœ… Terkonfigurasi';
                attendanceStatus.className = 'text-green-600';
            } else {
                attendanceStatus.textContent = 'âŒ Belum dikonfigurasi';
                attendanceStatus.className = 'text-red-600';
            }

            if (sheetsConfig.teacherSheetUrl) {
                teacherStatus.textContent = 'âœ… Terkonfigurasi';
                teacherStatus.className = 'text-green-600';
            } else {
                teacherStatus.textContent = 'âŒ Belum dikonfigurasi';
                teacherStatus.className = 'text-red-600';
            }

            if (sheetsConfig.autoSync) {
                autoSyncStatus.textContent = 'âœ… Aktif';
                autoSyncStatus.className = 'text-green-600';
            } else {
                autoSyncStatus.textContent = 'âŒ Nonaktif';
                autoSyncStatus.className = 'text-red-600';
            }
        }

        // Open sheets modal
        function openSheetsModal() {
            document.getElementById('sheetsModal').classList.remove('hidden');
            
            // Populate form with current config
            document.getElementById('attendanceSheetUrl').value = sheetsConfig.attendanceSheetUrl;
            document.getElementById('teacherSheetUrl').value = sheetsConfig.teacherSheetUrl;
            document.getElementById('enableAutoSync').checked = sheetsConfig.autoSync;
            
            updateSheetsStatus();
        }

        // Close sheets modal
        document.getElementById('closeSheetsModal').addEventListener('click', function() {
            document.getElementById('sheetsModal').classList.add('hidden');
        });

        // Close modal when clicking outside
        document.getElementById('sheetsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });

        // Sheets configuration form
        document.getElementById('sheetsConfigForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const attendanceUrl = document.getElementById('attendanceSheetUrl').value.trim();
            const teacherUrl = document.getElementById('teacherSheetUrl').value.trim();
            const autoSync = document.getElementById('enableAutoSync').checked;
            
            // Validate URLs
            if (attendanceUrl && !isValidGoogleSheetsUrl(attendanceUrl)) {
                showMessage('âŒ URL Google Sheets kehadiran tidak valid', 'error');
                return;
            }
            
            if (teacherUrl && !isValidGoogleSheetsUrl(teacherUrl)) {
                showMessage('âŒ URL Google Sheets data guru tidak valid', 'error');
                return;
            }
            
            // Save configuration
            sheetsConfig.attendanceSheetUrl = attendanceUrl;
            sheetsConfig.teacherSheetUrl = teacherUrl;
            sheetsConfig.autoSync = autoSync;
            
            saveSheetsConfig();
            
            // Close modal
            document.getElementById('sheetsModal').classList.add('hidden');
            
            showMessage('âœ… Konfigurasi Google Sheets berhasil disimpan!', 'success');
            
            // Show notification about how sync works
            if (autoSync && (attendanceUrl || teacherUrl)) {
                setTimeout(() => {
                    showSyncNotification('Sistem siap! Data baru akan disiapkan untuk copy-paste ke Google Sheets');
                }, 1000);
            }
        });

        // Validate Google Sheets URL
        function isValidGoogleSheetsUrl(url) {
            return url.includes('docs.google.com/spreadsheets') && url.includes('/d/');
        }

        // Extract sheet ID from URL
        function extractSheetId(url) {
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }

        // Test sheets connection
        document.getElementById('testSheetsBtn').addEventListener('click', function() {
            const attendanceUrl = document.getElementById('attendanceSheetUrl').value.trim();
            const teacherUrl = document.getElementById('teacherSheetUrl').value.trim();
            
            if (!attendanceUrl && !teacherUrl) {
                showMessage('âŒ Masukkan minimal satu URL Google Sheets untuk test', 'error');
                return;
            }
            
            let testResults = [];
            
            if (attendanceUrl) {
                if (isValidGoogleSheetsUrl(attendanceUrl)) {
                    testResults.push('âœ… URL Kehadiran: Valid');
                } else {
                    testResults.push('âŒ URL Kehadiran: Tidak valid');
                }
            }
            
            if (teacherUrl) {
                if (isValidGoogleSheetsUrl(teacherUrl)) {
                    testResults.push('âœ… URL Data Guru: Valid');
                } else {
                    testResults.push('âŒ URL Data Guru: Tidak valid');
                }
            }
            
            showMessage(testResults.join('\n'), testResults.every(r => r.includes('âœ…')) ? 'success' : 'error');
        });

        // Sync all data to sheets (prepare for copy-paste)
        function syncAllToSheets() {
            if (!sheetsConfig.attendanceSheetUrl && !sheetsConfig.teacherSheetUrl) {
                showMessage('âŒ Belum ada Google Sheets yang dikonfigurasi', 'error');
                return;
            }
            
            let syncData = '';
            const currentDate = new Date().toLocaleDateString('id-ID');
            
            // Prepare attendance data
            if (sheetsConfig.attendanceSheetUrl && attendanceData.length > 0) {
                syncData += 'DATA KEHADIRAN (Paste ke Sheet "Data Kehadiran KKG PAI" mulai dari baris 2):\n\n';
                
                attendanceData.forEach((item, index) => {
                    syncData += `${index + 1}\t${item.name}\t${item.school}\t${item.district || '-'}\t${item.status}\t${item.time}\t${item.method}\t${currentDate}\t${currentAdmin || 'sistem'}\t${item.notes || '-'}\n`;
                });
                
                syncData += '\n\n';
            }
            
            // Prepare teacher data
            if (sheetsConfig.teacherSheetUrl && teacherData.length > 0) {
                syncData += 'DATA GURU PAI (Paste ke Sheet "Data Guru PAI" mulai dari baris 2):\n\n';
                
                teacherData.forEach((item, index) => {
                    syncData += `${index + 1}\t${item.name}\t${item.school}\t${item.district}\t${currentDate}\t${currentAdmin || 'sistem'}\tAktif\n`;
                });
            }
            
            if (syncData) {
                pendingSyncData = syncData;
                showSyncNotification(`Semua data (${attendanceData.length} kehadiran, ${teacherData.length} guru) siap untuk copy-paste ke Google Sheets`);
            } else {
                showMessage('âŒ Tidak ada data untuk disinkronkan', 'error');
            }
        }

        // Auto-sync when new data is added (prepare for copy-paste)
        function autoSyncToSheets(type, data) {
            if (!sheetsConfig.autoSync) return;
            
            const currentDate = new Date().toLocaleDateString('id-ID');
            let syncData = '';
            
            if (type === 'attendance' && sheetsConfig.attendanceSheetUrl) {
                syncData = `${attendanceData.length}\t${data.name}\t${data.school}\t${data.district || '-'}\t${data.status}\t${data.time}\t${data.method}\t${currentDate}\t${currentAdmin || 'sistem'}\t${data.notes || '-'}`;
                pendingSyncData = syncData;
                showSyncNotification(`Data kehadiran ${data.name} siap untuk copy-paste ke Google Sheets`);
            } else if (type === 'teacher' && sheetsConfig.teacherSheetUrl) {
                syncData = `${teacherData.length}\t${data.name}\t${data.school}\t${data.district}\t${currentDate}\t${currentAdmin || 'sistem'}\tAktif`;
                pendingSyncData = syncData;
                showSyncNotification(`Data guru ${data.name} siap untuk copy-paste ke Google Sheets`);
            }
        }

        // Show sync notification
        function showSyncNotification(message) {
            const notification = document.getElementById('syncNotification');
            const text = document.getElementById('syncNotificationText');
            
            text.textContent = message;
            notification.classList.remove('hidden');
            
            // Auto-hide after 15 seconds
            setTimeout(() => {
                hideSyncNotification();
            }, 15000);
        }

        // Hide sync notification
        function hideSyncNotification() {
            document.getElementById('syncNotification').classList.add('hidden');
        }

        // Copy sync data to clipboard
        function copySyncData() {
            if (!pendingSyncData) {
                showMessage('âŒ Tidak ada data untuk dicopy', 'error');
                return;
            }
            
            navigator.clipboard.writeText(pendingSyncData).then(() => {
                showMessage('âœ… Data berhasil dicopy! Sekarang buka Google Sheets dan paste di baris yang sesuai', 'success');
                hideSyncNotification();
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = pendingSyncData;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                showMessage('âœ… Data berhasil dicopy! Sekarang buka Google Sheets dan paste di baris yang sesuai', 'success');
                hideSyncNotification();
            });
        }

        // Open Google Sheets in new tab
        function openSheetsInNewTab() {
            const urls = [];
            
            if (sheetsConfig.attendanceSheetUrl) {
                urls.push(sheetsConfig.attendanceSheetUrl);
            }
            
            if (sheetsConfig.teacherSheetUrl) {
                urls.push(sheetsConfig.teacherSheetUrl);
            }
            
            if (urls.length === 0) {
                showMessage('âŒ Belum ada Google Sheets yang dikonfigurasi', 'error');
                return;
            }
            
            urls.forEach(url => {
                window.open(url, '_blank', 'noopener,noreferrer');
            });
            
            showMessage(`âœ… Membuka ${urls.length} Google Sheets di tab baru`, 'success');
        }

        // Tab functionality
        document.getElementById('attendanceTab').addEventListener('click', function() {
            switchTab('attendance');
        });

        document.getElementById('teacherDataTab').addEventListener('click', function() {
            switchTab('teacherData');
        });

        document.getElementById('adminTab').addEventListener('click', function() {
            switchTab('admin');
        });

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-emerald-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });

            // Hide all content
            document.getElementById('attendanceContent').classList.add('hidden');
            document.getElementById('teacherDataContent').classList.add('hidden');
            document.getElementById('adminContent').classList.add('hidden');

            // Show/hide content
            if (tabName === 'attendance') {
                document.getElementById('attendanceTab').classList.add('active', 'bg-emerald-600', 'text-white');
                document.getElementById('attendanceTab').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('attendanceContent').classList.remove('hidden');
            } else if (tabName === 'teacherData') {
                document.getElementById('teacherDataTab').classList.add('active', 'bg-emerald-600', 'text-white');
                document.getElementById('teacherDataTab').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('teacherDataContent').classList.remove('hidden');
            } else if (tabName === 'admin') {
                document.getElementById('adminTab').classList.add('active', 'bg-emerald-600', 'text-white');
                document.getElementById('adminTab').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('adminContent').classList.remove('hidden');
            }
        }

        // Scanner functionality
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startScanBtn = document.getElementById('startScanBtn');
        const stopScanBtn = document.getElementById('stopScanBtn');
        const scannerPlaceholder = document.getElementById('scannerPlaceholder');
        const scannerOverlay = document.getElementById('scannerOverlay');
        const scanResult = document.getElementById('scanResult');

        startScanBtn.addEventListener('click', startScanner);
        stopScanBtn.addEventListener('click', stopScanner);
        
        // Debug toggle
        document.getElementById('toggleDebugBtn').addEventListener('click', function() {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo.classList.contains('hidden')) {
                debugInfo.classList.remove('hidden');
                this.textContent = 'ğŸ” Hide Debug';
                updateDebugInfo();
            } else {
                debugInfo.classList.add('hidden');
                this.textContent = 'ğŸ” Debug';
            }
        });
        
        function updateDebugInfo() {
            document.getElementById('jsqrStatus').textContent = typeof jsQR !== 'undefined' ? 'âœ… Loaded' : 'âŒ Not loaded';
            document.getElementById('videoStatus').textContent = video.videoWidth > 0 ? `âœ… ${video.videoWidth}x${video.videoHeight}` : 'âŒ No video';
            document.getElementById('debugText').textContent = scanning ? 'Scanning...' : 'Stopped';
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const loginError = document.getElementById('loginError');
            
            if (adminCredentials[username] && adminCredentials[username] === password) {
                isAdminLoggedIn = true;
                currentAdmin = username;
                
                // Show admin dashboard, hide login form
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                document.getElementById('loggedInUserDisplay').textContent = username;
                
                // Show manual entry section in attendance tab
                document.getElementById('manualEntrySection').classList.remove('hidden');
                document.getElementById('loggedInUser').textContent = username;
                
                // Show teacher data tab after login
                document.getElementById('teacherDataTab').classList.remove('hidden');
                
                // Clear login form
                document.getElementById('adminUsername').value = '';
                document.getElementById('adminPassword').value = '';
                loginError.classList.add('hidden');
                
                // Show success message
                showLoginMessage('âœ… Login berhasil! Selamat datang, ' + username, 'success');
            } else {
                loginError.textContent = 'âŒ Username atau password salah. Silakan coba lagi.';
                loginError.classList.remove('hidden');
                
                // Clear password field
                document.getElementById('adminPassword').value = '';
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            performLogout();
        });

        document.getElementById('logoutBtnMain').addEventListener('click', function() {
            performLogout();
        });

        function performLogout() {
            isAdminLoggedIn = false;
            currentAdmin = '';
            
            // Show login section, hide admin dashboard and manual entry
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('manualEntrySection').classList.add('hidden');
            
            // Hide teacher data tab after logout
            document.getElementById('teacherDataTab').classList.add('hidden');
            
            // Switch to attendance tab if currently on teacher data tab
            if (!document.getElementById('attendanceContent').classList.contains('hidden')) {
                // Already on attendance tab, do nothing
            } else if (!document.getElementById('teacherDataContent').classList.contains('hidden')) {
                // Currently on teacher data tab, switch to attendance
                switchTab('attendance');
            }
            
            // Clear any form data
            clearForm();
            
            showLoginMessage('ğŸ‘‹ Logout berhasil. Terima kasih!', 'info');
        }

        function showLoginMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-100 text-green-800' : 
                type === 'error' ? 'bg-red-100 text-red-800' : 
                'bg-blue-100 text-blue-800'
            }`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        async function startScanner() {
            try {
                // Check if getUserMedia is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Browser tidak mendukung akses kamera');
                }

                // Show loading state
                scannerPlaceholder.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-4">â³</div>
                        <p class="text-gray-600">Mengakses kamera...</p>
                    </div>
                `;

                // Multiple fallback strategies for mobile compatibility
                const cameraConfigs = [
                    // Try rear camera first (best for scanning)
                    { 
                        video: { 
                            facingMode: { exact: 'environment' },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    },
                    // Fallback to any rear camera
                    { 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    },
                    // Try front camera
                    { 
                        video: { 
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    },
                    // Basic video without specific facing mode
                    { 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    },
                    // Minimal constraints as last resort
                    { video: true }
                ];

                let cameraError = null;
                
                for (let i = 0; i < cameraConfigs.length; i++) {
                    try {
                        console.log(`Trying camera config ${i + 1}:`, cameraConfigs[i]);
                        stream = await navigator.mediaDevices.getUserMedia(cameraConfigs[i]);
                        console.log('Camera access successful with config:', i + 1);
                        break;
                    } catch (err) {
                        console.log(`Camera config ${i + 1} failed:`, err.name, err.message);
                        cameraError = err;
                        
                        // If this is the last config, throw the error
                        if (i === cameraConfigs.length - 1) {
                            throw err;
                        }
                    }
                }

                if (!stream) {
                    throw new Error('Tidak dapat mengakses kamera dengan konfigurasi apapun');
                }
                
                video.srcObject = stream;
                
                // Enhanced video ready detection
                await new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 10;
                    
                    const checkVideo = () => {
                        attempts++;
                        
                        if (video.readyState >= 2) { // HAVE_CURRENT_DATA
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            reject(new Error('Video tidak dapat dimuat setelah beberapa percobaan'));
                        } else {
                            setTimeout(checkVideo, 200);
                        }
                    };
                    
                    video.onloadedmetadata = () => {
                        video.play()
                            .then(() => {
                                console.log('Video playing successfully');
                                setTimeout(checkVideo, 100);
                            })
                            .catch(reject);
                    };
                    
                    video.onerror = reject;
                    
                    // Start checking immediately in case metadata is already loaded
                    setTimeout(checkVideo, 100);
                });
                
                // Show camera view
                scannerPlaceholder.style.display = 'none';
                video.style.display = 'block';
                scannerOverlay.style.display = 'block';
                stopScanBtn.classList.remove('hidden');
                
                scanning = true;
                
                // Show success message
                showScanResult('âœ… Kamera berhasil diakses! Arahkan ke QR Code untuk scan.', 'success');
                
                // Start scanning after ensuring video is stable
                setTimeout(() => {
                    if (scanning && video.videoWidth > 0 && video.videoHeight > 0) {
                        console.log('Starting barcode scan, video dimensions:', video.videoWidth, 'x', video.videoHeight);
                        scanBarcode();
                    } else if (scanning) {
                        console.log('Video not ready yet, retrying...');
                        setTimeout(() => {
                            if (scanning) scanBarcode();
                        }, 1000);
                    }
                }, 800);
                
            } catch (err) {
                console.error('Camera error details:', {
                    name: err.name,
                    message: err.message,
                    stack: err.stack
                });
                
                // Reset placeholder
                scannerPlaceholder.innerHTML = `
                    <div class="text-center">
                        <div class="text-6xl mb-4">ğŸ“·</div>
                        <button id="startScanBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                            Mulai Scan QR Code
                        </button>
                    </div>
                `;
                
                // Re-attach event listener
                document.getElementById('startScanBtn').addEventListener('click', startScanner);
                
                let errorMessage = 'âŒ Tidak dapat mengakses kamera. ';
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage += 'Izin kamera ditolak. Langkah-langkah:\n';
                    errorMessage += '1. Refresh halaman ini\n';
                    errorMessage += '2. Klik "Izinkan" saat browser meminta akses kamera\n';
                    errorMessage += '3. Periksa pengaturan browser untuk memastikan kamera tidak diblokir';
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    errorMessage += 'Kamera tidak ditemukan. Pastikan perangkat memiliki kamera yang berfungsi.';
                } else if (err.name === 'NotSupportedError' || err.name === 'NotSupportedError') {
                    errorMessage += 'Browser tidak mendukung akses kamera. Coba gunakan Chrome, Firefox, atau Safari terbaru.';
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    errorMessage += 'Kamera sedang digunakan aplikasi lain. Tutup aplikasi kamera lain dan coba lagi.';
                } else if (err.name === 'OverconstrainedError' || err.name === 'ConstraintNotSatisfiedError') {
                    errorMessage += 'Konfigurasi kamera tidak didukung. Perangkat mungkin tidak memiliki kamera belakang.';
                } else {
                    errorMessage += `Error: ${err.message}. Coba refresh halaman atau gunakan browser lain.`;
                }
                
                showScanResult(errorMessage, 'error');
            }
        }

        function stopScanner() {
            scanning = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            video.style.display = 'none';
            scannerOverlay.style.display = 'none';
            scannerPlaceholder.style.display = 'flex';
            stopScanBtn.classList.add('hidden');
            scanResult.classList.add('hidden');
        }

        function scanBarcode() {
            if (!scanning) {
                return;
            }
            
            if (!video.videoWidth || !video.videoHeight) {
                updateDebugInfo();
                setTimeout(() => scanBarcode(), 100);
                return;
            }

            try {
                // Set canvas size to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw current video frame to canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Get image data for QR code detection
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Update debug info
                updateDebugInfo();
                
                // Check if jsQR library is available
                if (typeof jsQR !== 'undefined') {
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code && code.data) {
                        console.log('QR Code detected:', code.data);
                        document.getElementById('debugText').textContent = `Found: ${code.data}`;
                        processBarcode(code.data);
                        return; // Stop scanning after successful detection
                    }
                } else {
                    console.warn('jsQR library not available');
                    document.getElementById('debugText').textContent = 'jsQR library missing';
                }
                
                // Continue scanning if no code detected
                if (scanning) {
                    requestAnimationFrame(scanBarcode);
                }
            } catch (err) {
                console.error('Scan error:', err);
                document.getElementById('debugText').textContent = `Error: ${err.message}`;
                if (scanning) {
                    setTimeout(() => scanBarcode(), 500);
                }
            }
        }

        function tryAlternativeDetection(imageData) {
            // Simple pattern detection as fallback
            // This is a basic implementation - in real apps you'd use a proper QR library
            console.log('Trying alternative QR detection...');
        }

        function processBarcode(data) {
            console.log('Processing barcode data:', data);
            
            // Stop scanning temporarily to prevent multiple scans
            const wasScanning = scanning;
            scanning = false;
            
            const barcodeText = data.trim();
            
            // Check if it's a PAI barcode format (PAI0001, PAI0002, etc.)
            const paiMatch = barcodeText.match(/^PAI(\d{4})$/);
            
            if (paiMatch) {
                const teacherId = parseInt(paiMatch[1]);
                console.log('Found PAI format, teacher ID:', teacherId);
                
                const teacher = teacherData.find(t => t.id === teacherId);
                
                if (teacher) {
                    console.log('Teacher found:', teacher);
                    
                    // Check if already recorded
                    const existing = attendanceData.find(item => 
                        item.name.toLowerCase() === teacher.name.toLowerCase() && 
                        item.school.toLowerCase() === teacher.school.toLowerCase()
                    );
                    
                    if (existing) {
                        showScanResult(`âš ï¸ ${teacher.name} sudah tercatat hadir sebelumnya`, 'error');
                    } else {
                        addAttendance(
                            teacher.name, 
                            teacher.school, 
                            'QR Scan',
                            teacher.district,
                            '',
                            'Hadir'
                        );
                        showScanResult(`âœ… Berhasil scan: ${teacher.name} dari ${teacher.school}`, 'success');
                        
                        // Play success sound (if supported)
                        try {
                            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                            audio.play().catch(() => {});
                        } catch (e) {}
                    }
                } else {
                    console.log('Teacher not found for ID:', teacherId);
                    showScanResult(`âŒ Guru dengan ID ${teacherId} tidak ditemukan dalam database`, 'error');
                }
            } else {
                console.log('Not PAI format, trying name matching for:', barcodeText);
                
                // Try to find teacher by name (fallback for other barcode formats)
                const foundTeacher = teacherData.find(t => 
                    t.name.toLowerCase().includes(barcodeText.toLowerCase()) ||
                    barcodeText.toLowerCase().includes(t.name.toLowerCase()) ||
                    barcodeText === t.name
                );
                
                if (foundTeacher) {
                    console.log('Teacher found by name:', foundTeacher);
                    
                    // Check if already recorded
                    const existing = attendanceData.find(item => 
                        item.name.toLowerCase() === foundTeacher.name.toLowerCase() && 
                        item.school.toLowerCase() === foundTeacher.school.toLowerCase()
                    );
                    
                    if (existing) {
                        showScanResult(`âš ï¸ ${foundTeacher.name} sudah tercatat hadir sebelumnya`, 'error');
                    } else {
                        addAttendance(
                            foundTeacher.name, 
                            foundTeacher.school, 
                            'QR Scan',
                            foundTeacher.district,
                            '',
                            'Hadir'
                        );
                        showScanResult(`âœ… Berhasil scan: ${foundTeacher.name} dari ${foundTeacher.school}`, 'success');
                    }
                } else {
                    console.log('No teacher found for barcode:', barcodeText);
                    showScanResult(`âŒ QR Code "${barcodeText}" tidak dikenali. Pastikan QR Code valid dan guru terdaftar.`, 'error');
                }
            }
            
            // Resume scanning after 3 seconds
            setTimeout(() => {
                if (wasScanning && video.style.display !== 'none') {
                    scanning = true;
                    scanBarcode();
                }
            }, 3000);
        }

        function showScanResult(message, type) {
            scanResult.textContent = message;
            scanResult.className = `p-4 rounded-lg mb-4 ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            scanResult.classList.remove('hidden');
        }

        // Name selection change handler
        document.getElementById('manualName').addEventListener('change', function() {
            const selectedTeacherId = this.value;
            
            if (selectedTeacherId) {
                const teacher = teacherData.find(t => t.id == selectedTeacherId);
                if (teacher) {
                    document.getElementById('manualSchool').value = teacher.school;
                    document.getElementById('manualDistrict').value = teacher.district;
                }
            } else {
                // Clear fields if no teacher selected
                document.getElementById('manualSchool').value = '';
                document.getElementById('manualDistrict').value = '';
            }
        });

        // Manual form
        document.getElementById('manualForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Check if admin is logged in
            if (!isAdminLoggedIn) {
                alert('âŒ Akses ditolak! Silakan login sebagai admin terlebih dahulu.');
                return;
            }
            
            const selectedTeacherId = document.getElementById('manualName').value;
            const status = document.getElementById('attendanceStatus').value.trim();
            
            if (selectedTeacherId && status) {
                const teacher = teacherData.find(t => t.id == selectedTeacherId);
                if (teacher) {
                    addAttendance(teacher.name, teacher.school, 'Manual', teacher.district, '', status);
                    clearForm();
                    
                    // Show success message
                    const form = this;
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalHTML = submitBtn.innerHTML;
                    submitBtn.innerHTML = 'âœ… Berhasil Ditambahkan!';
                    submitBtn.disabled = true;
                    setTimeout(() => {
                        submitBtn.innerHTML = originalHTML;
                        submitBtn.disabled = false;
                    }, 2000);
                }
            }
        });

        // Clear form button
        document.getElementById('clearFormBtn').addEventListener('click', clearForm);

        function clearForm() {
            document.getElementById('manualName').value = '';
            document.getElementById('manualSchool').value = '';
            document.getElementById('manualDistrict').value = '';
            document.getElementById('attendanceStatus').value = '';
        }

        function addAttendance(name, school, method, district = '', notes = '', status = 'Hadir') {
            // Check for duplicates
            const existing = attendanceData.find(item => 
                item.name.toLowerCase() === name.toLowerCase() && 
                item.school.toLowerCase() === school.toLowerCase()
            );
            
            if (existing) {
                if (method === 'Barcode') {
                    showScanResult(`âš ï¸ ${name} sudah tercatat hadir sebelumnya`, 'error');
                } else {
                    alert(`âš ï¸ ${name} dari ${school} sudah tercatat hadir sebelumnya`);
                }
                return;
            }

            const attendance = {
                id: Date.now(),
                name: name,
                school: school,
                district: district,
                notes: notes,
                status: status,
                time: new Date().toLocaleTimeString('id-ID'),
                method: method
            };
            
            attendanceData.push(attendance);
            updateAttendanceList();
            
            // Auto-sync to Google Sheets if enabled
            autoSyncToSheets('attendance', attendance);
        }

        function updateAttendanceList() {
            const tbody = document.getElementById('attendanceList');
            const emptyState = document.getElementById('emptyState');
            const totalCount = document.getElementById('totalCount');
            
            if (attendanceData.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                totalCount.textContent = '0';
                document.getElementById('hadirCount').textContent = '0';
                document.getElementById('sakitCount').textContent = '0';
                document.getElementById('izinCount').textContent = '0';
                document.getElementById('alphaCount').textContent = '0';
                return;
            }
            
            emptyState.style.display = 'none';
            totalCount.textContent = attendanceData.length;
            
            // Update status counts
            const hadirCount = attendanceData.filter(item => item.status === 'Hadir').length;
            const sakitCount = attendanceData.filter(item => item.status === 'Sakit').length;
            const izinCount = attendanceData.filter(item => item.status === 'Izin').length;
            const alphaCount = attendanceData.filter(item => item.status === 'Alpha').length;
            
            document.getElementById('hadirCount').textContent = hadirCount;
            document.getElementById('sakitCount').textContent = sakitCount;
            document.getElementById('izinCount').textContent = izinCount;
            document.getElementById('alphaCount').textContent = alphaCount;
            
            tbody.innerHTML = attendanceData.map((item, index) => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-2 text-sm font-medium">${index + 1}</td>
                    <td class="py-3 px-2">
                        <div class="font-medium text-gray-900">${item.name}</div>
                    </td>
                    <td class="py-3 px-2 text-gray-700 text-sm">${item.school}</td>
                    <td class="py-3 px-2 text-gray-700 text-sm">${item.district || '-'}</td>
                    <td class="py-3 px-2">
                        <span class="px-2 py-1 text-xs rounded-full ${
                            item.status === 'Hadir' ? 'bg-green-100 text-green-800' :
                            item.status === 'Sakit' ? 'bg-yellow-100 text-yellow-800' :
                            item.status === 'Izin' ? 'bg-blue-100 text-blue-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${item.status === 'Hadir' ? 'âœ…' : item.status === 'Sakit' ? 'ğŸ¤’' : item.status === 'Izin' ? 'ğŸ“' : 'âŒ'} ${item.status}
                        </span>
                    </td>
                    <td class="py-3 px-2 text-sm text-gray-600">${item.time}</td>
                    <td class="py-3 px-2">
                        <span class="px-2 py-1 text-xs rounded-full ${item.method === 'Barcode' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                            ${item.method === 'Barcode' ? 'ğŸ“± Scan' : 'âœï¸ Manual'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (attendanceData.length === 0) {
                alert('Tidak ada data kehadiran untuk diekspor');
                return;
            }

            const currentDate = new Date().toLocaleDateString('id-ID');
            const currentTime = new Date().toLocaleTimeString('id-ID');
            let csvContent = `DAFTAR HADIR KELOMPOK KERJA GURU (KKG) PAI BINAAN\n`;
            csvContent += `Pengawas: Dewi Yuliani, S.Ag, MA\n`;
            csvContent += `Tanggal: ${currentDate}\n`;
            csvContent += `Waktu Export: ${currentTime}\n`;
            csvContent += `Admin Export: ${currentAdmin || 'Sistem'}\n`;
            csvContent += `Total Peserta: ${attendanceData.length} orang\n\n`;
            csvContent += 'No,Nama Lengkap,Sekolah,Kecamatan,Status Kehadiran,Waktu Input,Metode Input,Catatan\n';
            
            attendanceData.forEach((item, index) => {
                csvContent += `${index + 1},"${item.name}","${item.school}","${item.district || '-'}","${item.status || 'Hadir'}","${item.time}","${item.method}","${item.notes || '-'}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Daftar_Hadir_KKG_PAI_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            const btn = this;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = 'âœ… Data Berhasil Diexport!';
            btn.disabled = true;
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }, 2000);
        });

        // Teacher Data Management
        document.getElementById('addTeacherBtn').addEventListener('click', function() {
            document.getElementById('teacherFormSection').classList.remove('hidden');
            editingTeacherId = null;
            clearTeacherForm();
        });

        document.getElementById('cancelTeacherBtn').addEventListener('click', function() {
            document.getElementById('teacherFormSection').classList.add('hidden');
            editingTeacherId = null;
            clearTeacherForm();
        });

        document.getElementById('teacherForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('teacherName').value.trim();
            const school = document.getElementById('teacherSchool').value.trim();
            const district = document.getElementById('teacherDistrict').value.trim();
            
            if (name && school && district) {
                if (editingTeacherId) {
                    updateTeacher(editingTeacherId, name, school, district);
                } else {
                    addTeacher(name, school, district);
                }
                
                document.getElementById('teacherFormSection').classList.add('hidden');
                clearTeacherForm();
                editingTeacherId = null;
            }
        });

        function addTeacher(name, school, district) {
            // Check for duplicates
            const existing = teacherData.find(item => 
                item.name.toLowerCase() === name.toLowerCase() && 
                item.school.toLowerCase() === school.toLowerCase()
            );
            
            if (existing) {
                alert(`âš ï¸ ${name} dari ${school} sudah ada dalam database`);
                return;
            }

            const teacher = {
                id: Date.now(),
                name: name,
                school: school,
                district: district
            };
            
            teacherData.push(teacher);
            updateTeacherList();
            
            // Auto-sync to Google Sheets if enabled
            autoSyncToSheets('teacher', teacher);
            
            // Show success message
            showMessage('âœ… Data guru berhasil ditambahkan!', 'success');
        }

        function updateTeacher(id, name, school, district) {
            const index = teacherData.findIndex(item => item.id === id);
            if (index !== -1) {
                teacherData[index] = {
                    id: id,
                    name: name,
                    school: school,
                    district: district
                };
                updateTeacherList();
                showMessage('âœ… Data guru berhasil diperbarui!', 'success');
            }
        }

        function deleteTeacher(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data guru ini?')) {
                teacherData = teacherData.filter(item => item.id !== id);
                updateTeacherList();
                showMessage('âœ… Data guru berhasil dihapus!', 'success');
            }
        }

        function editTeacher(id) {
            const teacher = teacherData.find(item => item.id === id);
            if (teacher) {
                document.getElementById('teacherName').value = teacher.name;
                document.getElementById('teacherSchool').value = teacher.school;
                document.getElementById('teacherDistrict').value = teacher.district;
                
                editingTeacherId = id;
                document.getElementById('teacherFormSection').classList.remove('hidden');
            }
        }

        function clearTeacherForm() {
            document.getElementById('teacherName').value = '';
            document.getElementById('teacherSchool').value = '';
            document.getElementById('teacherDistrict').value = '';
        }

        function updateTeacherList() {
            const tbody = document.getElementById('teacherList');
            const emptyState = document.getElementById('teacherEmptyState');
            
            if (teacherData.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                updateTeacherSelect();
                return;
            }
            
            emptyState.style.display = 'none';
            
            tbody.innerHTML = teacherData.map((item, index) => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-2 text-sm font-medium">${index + 1}</td>
                    <td class="py-3 px-2 font-medium text-gray-900">${item.name}</td>
                    <td class="py-3 px-2 text-gray-700 text-sm">${item.school}</td>
                    <td class="py-3 px-2 text-gray-700 text-sm">${item.district}</td>

                    <td class="py-3 px-2">
                        <div class="flex gap-2">
                            <button onclick="editTeacher(${item.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                âœï¸ Edit
                            </button>
                            <button onclick="deleteTeacher(${item.id})" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                ğŸ—‘ï¸ Hapus
                            </button>
                            <button onclick="generateBarcode(${item.id})" class="text-green-600 hover:text-green-800 text-sm font-medium">
                                ğŸ“± QR Code
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Update teacher select dropdown
            updateTeacherSelect();
        }

        function updateTeacherSelect() {
            const select = document.getElementById('manualName');
            const currentValue = select.value;
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">Pilih nama guru...</option>';
            
            // Add teacher options
            teacherData.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                select.appendChild(option);
            });
            
            // Restore selected value if it still exists
            if (currentValue && teacherData.find(t => t.id == currentValue)) {
                select.value = currentValue;
            }
        }

        // Export teacher data
        document.getElementById('exportTeacherBtn').addEventListener('click', function() {
            if (teacherData.length === 0) {
                alert('Tidak ada data guru untuk diekspor');
                return;
            }

            const currentDate = new Date().toLocaleDateString('id-ID');
            const currentTime = new Date().toLocaleTimeString('id-ID');
            let csvContent = `DATA GURU PAI\n`;
            csvContent += `Pengawas: Dewi Yuliani, S.Ag, MA\n`;
            csvContent += `Tanggal Export: ${currentDate}\n`;
            csvContent += `Waktu Export: ${currentTime}\n`;
            csvContent += `Admin Export: ${currentAdmin || 'Sistem'}\n`;
            csvContent += `Total Guru: ${teacherData.length} orang\n\n`;
            csvContent += 'No,Nama Lengkap,Sekolah,Kecamatan\n';
            
            teacherData.forEach((item, index) => {
                csvContent += `${index + 1},"${item.name}","${item.school}","${item.district}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Data_Guru_PAI_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            const btn = this;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = 'âœ… Data Berhasil Diexport!';
            btn.disabled = true;
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }, 2000);
        });

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-100 text-green-800' : 
                type === 'error' ? 'bg-red-100 text-red-800' : 
                'bg-blue-100 text-blue-800'
            }`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Barcode Generation Functions
        let currentBarcodeData = null;

        function generateBarcode(teacherId) {
            const teacher = teacherData.find(item => item.id === teacherId);
            if (!teacher) return;

            // Show modal
            document.getElementById('barcodeModal').classList.remove('hidden');
            
            // Update teacher info
            document.getElementById('barcodeTeacherName').textContent = teacher.name;
            document.getElementById('barcodeTeacherSchool').textContent = teacher.school;
            document.getElementById('barcodeTeacherDistrict').textContent = teacher.district;
            
            // Create barcode data - use teacher ID for simpler barcode
            const barcodeText = `PAI${teacher.id.toString().padStart(4, '0')}`;
            
            currentBarcodeData = {
                id: teacher.id,
                name: teacher.name,
                school: teacher.school,
                district: teacher.district,
                barcodeText: barcodeText,
                timestamp: new Date().toISOString()
            };
            
            // Generate barcode
            const canvas = document.getElementById('barcodeCanvas');
            
            // Set canvas size for QR Code
            canvas.width = 300;
            canvas.height = 300;
            
            console.log('Generating barcode for:', teacher.name);
            console.log('Barcode text:', barcodeText);
            
            // Try multiple QR Code libraries for better compatibility
            let qrGenerated = false;
            
            // Method 1: Try QRCode library
            if (typeof QRCode !== 'undefined' && !qrGenerated) {
                try {
                    QRCode.toCanvas(canvas, barcodeText, {
                        width: 300,
                        height: 300,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#ffffff'
                        }
                    }, function (error) {
                        if (error) {
                            console.log('QRCode library failed, trying QRious...');
                            tryQRious();
                        } else {
                            console.log('QR Code generated successfully with QRCode library');
                            qrGenerated = true;
                        }
                    });
                } catch (e) {
                    console.log('QRCode library exception, trying QRious...');
                    tryQRious();
                }
            } else {
                tryQRious();
            }
            
            // Method 2: Try QRious library
            function tryQRious() {
                if (typeof QRious !== 'undefined' && !qrGenerated) {
                    try {
                        const qr = new QRious({
                            element: canvas,
                            value: barcodeText,
                            size: 300,
                            background: 'white',
                            foreground: 'black',
                            level: 'M'
                        });
                        console.log('QR Code generated successfully with QRious library');
                        qrGenerated = true;
                    } catch (e) {
                        console.log('QRious library failed, trying manual generation...');
                        tryManualQR();
                    }
                } else {
                    tryManualQR();
                }
            }
            
            // Method 3: Manual QR Code generation using canvas
            function tryManualQR() {
                if (!qrGenerated) {
                    try {
                        generateManualQRCode(canvas, barcodeText);
                        console.log('QR Code generated successfully with manual method');
                        qrGenerated = true;
                    } catch (e) {
                        console.log('Manual QR generation failed, using fallback...');
                        createFallbackQRCode(canvas.getContext('2d'), teacher);
                    }
                }
            }
        }

        // Manual QR Code generation function
        function generateManualQRCode(canvas, text) {
            const ctx = canvas.getContext('2d');
            const size = 300;
            const modules = 25; // QR Code grid size
            const moduleSize = Math.floor(size / modules);
            const offset = (size - (modules * moduleSize)) / 2;
            
            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#000000';
            
            // Create a simple pattern based on text
            const pattern = createQRPattern(text, modules);
            
            // Draw QR Code pattern
            for (let row = 0; row < modules; row++) {
                for (let col = 0; col < modules; col++) {
                    if (pattern[row][col]) {
                        ctx.fillRect(
                            offset + col * moduleSize,
                            offset + row * moduleSize,
                            moduleSize,
                            moduleSize
                        );
                    }
                }
            }
        }
        
        function createQRPattern(text, size) {
            const pattern = Array(size).fill().map(() => Array(size).fill(false));
            
            // Add finder patterns (corner squares)
            addFinderPattern(pattern, 0, 0);
            addFinderPattern(pattern, 0, size - 7);
            addFinderPattern(pattern, size - 7, 0);
            
            // Add timing patterns
            for (let i = 8; i < size - 8; i++) {
                pattern[6][i] = i % 2 === 0;
                pattern[i][6] = i % 2 === 0;
            }
            
            // Add data pattern based on text
            let hash = 0;
            for (let i = 0; i < text.length; i++) {
                hash = ((hash << 5) - hash + text.charCodeAt(i)) & 0xffffffff;
            }
            
            for (let row = 0; row < size; row++) {
                for (let col = 0; col < size; col++) {
                    if (!isReservedArea(row, col, size)) {
                        const seed = (row * size + col + hash) % 7;
                        pattern[row][col] = seed < 3;
                    }
                }
            }
            
            return pattern;
        }
        
        function addFinderPattern(pattern, startRow, startCol) {
            // 7x7 finder pattern
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    const r = startRow + row;
                    const c = startCol + col;
                    if (r >= 0 && r < pattern.length && c >= 0 && c < pattern[0].length) {
                        // Outer border
                        if (row === 0 || row === 6 || col === 0 || col === 6) {
                            pattern[r][c] = true;
                        }
                        // Inner square
                        else if (row >= 2 && row <= 4 && col >= 2 && col <= 4) {
                            pattern[r][c] = true;
                        }
                        // White border around inner square
                        else {
                            pattern[r][c] = false;
                        }
                    }
                }
            }
        }
        
        function isReservedArea(row, col, size) {
            // Finder patterns and separators
            if ((row < 9 && col < 9) || 
                (row < 9 && col >= size - 8) || 
                (row >= size - 8 && col < 9)) {
                return true;
            }
            
            // Timing patterns
            if (row === 6 || col === 6) {
                return true;
            }
            
            return false;
        }

        function createFallbackQRCode(ctx, teacher) {
            // Create a simple visual QR Code as fallback
            const canvas = ctx.canvas;
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw QR Code-like pattern
            ctx.fillStyle = '#000000';
            const qrText = `PAI${teacher.id.toString().padStart(4, '0')}`;
            
            // Draw grid pattern to simulate QR Code
            const cellSize = 8;
            const startX = 50;
            const startY = 50;
            const gridSize = 15;
            
            // Create a simple pattern based on teacher ID
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    // Create pseudo-random pattern based on position and teacher ID
                    const seed = (i * gridSize + j + teacher.id) % 7;
                    if (seed < 3) {
                        ctx.fillRect(startX + i * cellSize, startY + j * cellSize, cellSize - 1, cellSize - 1);
                    }
                }
            }
            
            // Draw corner squares (QR Code markers)
            const markerSize = cellSize * 3;
            // Top-left
            ctx.fillRect(startX, startY, markerSize, markerSize);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(startX + cellSize, startY + cellSize, cellSize, cellSize);
            
            // Top-right
            ctx.fillStyle = '#000000';
            ctx.fillRect(startX + (gridSize - 3) * cellSize, startY, markerSize, markerSize);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(startX + (gridSize - 2) * cellSize, startY + cellSize, cellSize, cellSize);
            
            // Bottom-left
            ctx.fillStyle = '#000000';
            ctx.fillRect(startX, startY + (gridSize - 3) * cellSize, markerSize, markerSize);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(startX + cellSize, startY + (gridSize - 2) * cellSize, cellSize, cellSize);
            
            // Add text below QR Code
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 14px monospace';
            ctx.textAlign = 'center';
            ctx.fillText(qrText, canvas.width / 2, startY + gridSize * cellSize + 30);
            
            showMessage('âš ï¸ QR Code library error, menggunakan QR Code alternatif', 'error');
        }

        // Modal close functionality
        document.getElementById('closeBarcodeModal').addEventListener('click', function() {
            document.getElementById('barcodeModal').classList.add('hidden');
        });

        // Close modal when clicking outside
        document.getElementById('barcodeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });

        // Download barcode
        document.getElementById('downloadBarcode').addEventListener('click', function() {
            if (!currentBarcodeData) return;
            
            const canvas = document.getElementById('barcodeCanvas');
            const link = document.createElement('a');
            link.download = `QRCode_${currentBarcodeData.name.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            showMessage('âœ… QR Code berhasil didownload!', 'success');
        });

        // Print barcode
        document.getElementById('printBarcode').addEventListener('click', function() {
            if (!currentBarcodeData) return;
            
            const canvas = document.getElementById('barcodeCanvas');
            const printWindow = window.open('', '_blank');
            const img = canvas.toDataURL();
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>QR Code Kehadiran - ${currentBarcodeData.name}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            text-align: center; 
                            padding: 20px;
                            margin: 0;
                        }
                        .header {
                            margin-bottom: 20px;
                        }
                        .teacher-info {
                            background: #f0fdf4;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 20px 0;
                            border: 2px solid #10b981;
                        }
                        .barcode-container {
                            margin: 20px 0;
                        }
                        .footer {
                            margin-top: 20px;
                            font-size: 12px;
                            color: #666;
                        }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>ğŸ“š QR CODE KEHADIRAN KKG PAI</h2>
                        <p><strong>Pengawas: Dewi Yuliani, S.Ag, MA</strong></p>
                    </div>
                    
                    <div class="teacher-info">
                        <h3>${currentBarcodeData.name}</h3>
                        <p><strong>Sekolah:</strong> ${currentBarcodeData.school}</p>
                        <p><strong>Kecamatan:</strong> ${currentBarcodeData.district}</p>
                    </div>
                    
                    <div class="barcode-container">
                        <img src="${img}" alt="Barcode" style="max-width: 200px; height: auto;">
                    </div>
                    
                    <div class="footer">
                        <p>Scan QR Code ini untuk mencatat kehadiran secara otomatis</p>
                        <p>Dibuat pada: ${new Date().toLocaleDateString('id-ID', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
            
            showMessage('âœ… QR Code siap untuk dicetak!', 'success');
        });

        // Sample teacher data for testing
        function initializeSampleData() {
            if (teacherData.length === 0) {
                const sampleTeachers = [
                    { id: 1, name: "Ahmad Budi Santoso, S.Pd.I", school: "SDN 01 Sukamaju", district: "Sukamaju" },
                    { id: 2, name: "Siti Nurhaliza, S.Ag", school: "SDN 02 Sukamaju", district: "Sukamaju" },
                    { id: 3, name: "Muhammad Rizki, S.Pd.I", school: "SDN 03 Makmur", district: "Makmur" },
                    { id: 4, name: "Fatimah Zahra, S.Ag", school: "SDN 01 Sejahtera", district: "Sejahtera" },
                    { id: 5, name: "Abdul Rahman, S.Pd.I", school: "SDN 02 Sejahtera", district: "Sejahtera" }
                ];
                
                teacherData = sampleTeachers;
                updateTeacherList();
            }
        }

        // Initialize
        updateAttendanceList();
        updateTeacherList();
        initializeSampleData();
        loadSheetsConfig();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98bc77e764dbfb86',t:'MTc1OTk5ODEyNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
