function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    if (data.action === 'addTeacher') {
      const sheet = ss.getSheetByName('DataGuru');
      sheet.appendRow([
        data.data.id,
        data.data.name,
        data.data.school,
        data.data.district,
        new Date(data.data.createdAt)
      ]);
    } else if (data.action === 'addAttendance') {
      const sheet = ss.getSheetByName('DataAbsensi');
      sheet.appendRow([
        data.data.id,
        data.data.userId,
        data.data.namaLengkap,
        data.data.sekolah,
        data.data.kecamatan,
        data.data.date,
        data.data.time,
        new Date(data.data.timestamp)
      ]);
    }
    
    return ContentService.createTextOutput('Success');
  } catch (error) {
    return ContentService.createTextOutput('Error: ' + error.toString());
  }
}

function doGet(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    if (e.parameter.action === 'getTeachers') {
      const sheet = ss.getSheetByName('DataGuru');
      
      // Check if sheet has data
      if (sheet.getLastRow() <= 1) {
        return ContentService
          .createTextOutput(JSON.stringify([]))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      const data = sheet.getDataRange().getValues();
      const rows = data.slice(1); // Skip header row
      
      const teachers = rows.filter(row => row[0]).map(row => ({
        id: row[0] ? row[0].toString() : '',
        name: row[1] ? row[1].toString() : '',
        school: row[2] ? row[2].toString() : '',
        district: row[3] ? row[3].toString() : '',
        createdAt: row[4] ? row[4] : new Date()
      }));
      
      return ContentService
        .createTextOutput(JSON.stringify(teachers))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    if (e.parameter.action === 'getAttendance') {
      const sheet = ss.getSheetByName('DataAbsensi');
      
      // Check if sheet has data
      if (sheet.getLastRow() <= 1) {
        return ContentService
          .createTextOutput(JSON.stringify([]))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      const data = sheet.getDataRange().getValues();
      const rows = data.slice(1); // Skip header row
      
      const attendance = rows.filter(row => row[0]).map(row => ({
        id: row[0] ? row[0] : '',
        userId: row[1] ? row[1].toString() : '',
        namaLengkap: row[2] ? row[2].toString() : '',
        sekolah: row[3] ? row[3].toString() : '',
        kecamatan: row[4] ? row[4].toString() : '',
        date: row[5] ? row[5].toString() : '',
        time: row[6] ? row[6].toString() : '',
        timestamp: row[7] ? row[7] : new Date()
      }));
      
      return ContentService
        .createTextOutput(JSON.stringify(attendance))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput('No action specified');
  } catch (error) {
    return ContentService.createTextOutput('Error: ' + error.toString());
  }
}